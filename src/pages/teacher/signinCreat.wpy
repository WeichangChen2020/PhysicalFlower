<style type="less">
@import '../../public/style/public.wxss';
/* @import '../../public/style/index.wxss'; */
page {
  width: 100%;
  height: 100%;
}

.greeting {
  font-size: 14px;
  color: gray;
  margin: 20rpx 0 10rpx 20rpx;
}
.img_hd {
  width: 670rpx;
  display: flex;
  flex-direction: row;
  text-align: center;
}
.agreement {
  color: #66e;
  font-style: italic;
  text-decoration: underline;
}

.border {
  display: flex;
  flex-direction: column;
  align-items: center;
  background-color: white;
  border-width: 4rpx 0 4rpx 0;
  border-style: solid;
  border-color: #eee;
  font-size: 30rpx;
  line-height: 60rpx;
  color: #b95;
  padding: 20rpx 20rpx 40rpx 20rpx;
}
.btn {
  background: linear-gradient(150deg, #d188fb, #9587f8, #558bf7); 
  background-color: #f7536b;
  border: #eee solid 2rpx;
  border-radius: 100rpx;
  color: white;
  width: 295rpx;
  font-size: 30rpx;
  line-height: 70rpx;
}
.input {
  margin-top: 30rpx;
  border-bottom: #ddd solid 2rpx;
}

.flex {
  display: flex;
}
.flex-wrap {
  flex-wrap: wrap;
}
.flex-col {
  flex-direction: column;
}

/*head   search*/
.pageContainer .search {
  width: 737rpx;
  height: 65rpx;
  padding: 12.5rpx 0 12.5rpx 15rpx;
  background: #4bbc93;
}
.pageContainer .search-left {
  flex: 15;
  background: #52cc9f;
  text-align: left;
}
.pageContainer .search-left input {
  display: inline-block;
  height: 65rpx;
  color: #fff;
  font-size: 26rpx;
}
.search-placeholder {
  color: #fff;
  line-height: 26rpx;
  padding-top: 5rpx;
}
.pageContainer .search .search-left image {
  display: inline-block;
  width: 35rpx;
  height: 35rpx;
  padding: 15rpx 15rpx 15rpx 20rpx;
}
.pageContainer .search .search-right {
  flex: 2;
  margin-left: 20rpx;
}
.pageContainer .search .search-right image {
  width: 35rpx;
  height: 35rpx;
  padding: 15rpx;
}
/*ad*/
.ad,
.course-grp-item {
  width: 700rpx;
  margin: 20rpx 0;
  flex-wrap: wrap;
  justify-content: space-between;
}
.ad navigator:first-child image {
  width: 700rpx;
  height: 160rpx;
}
.ad image,
.course-grp-item image {
  margin-top: 10rpx;
  width: 335rpx;
  height: 160rpx;
  
}

.container {
  background: #f9f9f9;
  overflow: hidden;
  min-height: 100vh;
  box-sizing: border-box;
  padding: 15px 0;
}
.container::before {
  position: fixed;
  top: 0;
  left: 0;
  content: ' ';
  width: 100%;
  height: 1rpx;
  background-color: #e2e2e2;
  z-index: 5;
}
.doc-title {
  position: relative;
  padding: 15px 0;
  margin: 10px 15px;
  line-height: 25px;
  font-size: 25px;
  color: #666;
}
.doc-description {
  margin: 14px 0;
  padding: 0 15px;
  font-size: 14px;
  line-height: 20px;
  color: #666;
}

/*  车库题目样式*/
/* CSS Document */
.row:after {
  visibility: hidden;
  display: block;
  font-size: 0;
  content: ' ';
  clear: both;
  height: 0;
}
.row {
  display: inline-table;
} /* Hides from IE-mac \*/
html .row {
  height: 1%;
}
.row {
  display: block;
} /* End hide from IE-mac */
.col-hg-1,
.col-hg-2,
.col-hg-3,
.col-hg-4,
.col-hg-5,
.col-hg-6,
.col-hg-7,
.col-hg-8,
.col-hg-9,
.col-hg-10,
.col-hg-11,
.col-hg-12 {
  float: left;
  box-sizing: border-box;
}
.col-hg-12 {
  width: 100%;
}
.col-hg-11 {
  width: 91.6667%;
}
.col-hg-10 {
  width: 83.3333%;
}
.col-hg-9 {
  width: 75%;
}
.col-hg-8 {
  width: 66.6667%;
}
.col-hg-7 {
  width: 40%;
}
.col-hg-6 {
  width: 50%;
}
.col-hg-5 {
  width: 41.6667%;
}
.col-hg-4 {
  width: 33.3333%;
}
.col-hg-3 {
  width: 25%;
}
.col-hg-2 {
  width: 16.6667%;
}
.col-hg-1 {
  width: 8.33333%;
}
/*classify-lists*/
.classify-exer-lists {
  background: #fff;
  margin-top: 10rpx;
}
.classify-exer-lists.first {
  margin-top: 0;
}

.classify-exer-lists .classify-exer-list {
  position: relative;
  padding: 27rpx 0 27rpx 90rpx;
  border-bottom: 1rpx solid #f6f6f6;
  font-size: 30rpx;
  line-height: 46rpx;
}

.classify-exer-lists .classify-exer-list .icon-exer {
  position: absolute;
  left: 30rpx;
  top: 50%;
  transform: translate3d(0, -50%, 0px);
  -webkit-transform: translate3d(0, -50%, 0px);
  width: 40rpx;
  height: 40rpx;
  border-radius: 20rpx;
  background: #fc8f02
    url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAYAAADAQbwGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAABmJLR0QAAAAAAAD5Q7t/AAAACXBIWXMAAAsSAAALEgHS3X78AAABWUlEQVQ4y6WVsUpjURCGvwnR1cbKgEXYaq1MHkBBCIJW1iu+irXd4mtYWW29SGzFFGqpIIqCEIslpYKfRU4gXO5JbuLfnMvM/T9m5lzmorbVa2fXb0pUB06BN2AP+KCaBC7LM0PtVgRNVS2dVSubqnqm6jVgqSLjMSLMAtUa8AQsVATuAv+ywIj4VH/OUuHUliPidd4Z1sqCal2t50yT8rWM5w/QUxslsAbQA04K8XX1YvQddgrJX+qDejsOVRspdqc2C56O6UbLZngPbAPLQFdtJkA3vbIVEc+ztEwydIAfCdQFPoGdiOjnfNnBj6BpCfRSaHMSbGKFo1kCfxkugkvgTN2YC6i2U5svDDfRXnruplzWWHbLbbWvnqsrY/GVFOurrYInf8vAAXAF7EfEYGymA2A/5Q4rVziPihUufhdI2k6h3gD/gWPg/RuwI2AVtTXnT6qoa7X9BT+zVy5f6mfUAAAAAElFTkSuQmCC')
    no-repeat center/20rpx 22rpx;
  overflow: hidden;
}
.classify-exer-lists .classify-exer-list.left {
  border-right: 1rpx solid #f6f6f6;
}

.classify-exer-lists .classify-exer-list .special-exer-tip {
  position: absolute;
  left: 30rpx;
  top: 50%;
  transform: translate3d(0, -50%, 0px);
  -webkit-transform: translate3d(0, -50%, 0px);
  width: 40rpx;
  height: 40rpx;
  background: #73d263;
  border-radius: 20rpx;
  font-size: 24rpx;
  color: #fff;
  text-align: center;
  line-height: 40rpx;
}
.classify-exer-lists.num .classify-exer-list {
  counter-increment: my;
}
.classify-exer-lists.num .classify-exer-list:after {
  position: absolute;
  left: 30rpx;
  top: 50%;
  transform: translate3d(0, -50%, 0px);
  -webkit-transform: translate3d(0, -50%, 0px);
  width: 40rpx;
  height: 40rpx;
  content: counter(my);
  background: #0ae;
  border-radius: 20rpx;
  font-size: 24rpx;
  color: #fff;
  text-align: center;
  line-height: 40rpx;
}
.classify-exer-lists.num .classify-exer-list .classify-exam-num {
  position: absolute;
  right: 30rpx;
  top: 50%;
  transform: translate3d(0, -50%, 0px);
  -webkit-transform: translate3d(0, -50%, 0px);
  font-size: 24rpx;
  color: #999;
  vertical-align: middle;
}
.classify-exer-lists.num
  .classify-exer-list
  .classify-exam-num
  .icon-label-class {
  display: inline-block;
  width: 12rpx;
  height: 20rpx;
  margin-left: 4rpx;
  background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAASCAYAAABit09LAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAABmJLR0QAAAAAAAD5Q7t/AAAACXBIWXMAAAsSAAALEgHS3X78AAAA4ElEQVQoz43Rr0qEQRiF8We/9SYMgoIIFoPFC7CsxWSyaJHTDGI2LqggosUHDGtQEEyLYcU/WC0Gr8gyGtZvdn3j8GPeOWdQ79UeU6YBzoAbdXMiTPIBbABX6takG0nyCfSAC3W7Cgv+AtaBY3V3HHbGD9Ql4BnoJ7EKC14AXoDzJJdVWPBcwddJTquw4FngFbht+N90u1NWvwGDJP1amPmy8jdM04IWgXfg5Af9Sa0uA0/AUZJBa+HqCjACDpPctf6Mugo8AvtJHtre3VHXgCGwl2RYa2EGOAB2kowmFfkNyq5O87vOCYoAAAAASUVORK5CYII=')
    no-repeat center/10rpx 18rpx;
}
.metadata {
  display: table;
  height: 300px;
  width: 100%;
}
.metadata view {
  display: table-cell;
  vertical-align: middle;
  text-align: center;
  color: #999;
}

.container {
  height: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: space-between;
  padding: 200rpx 0;
  box-sizing: border-box;
}
/**app.wxss**/
.pageContainer {
  height: 100%;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  box-sizing: border-box;
}

</style>
<template>
    <canvas canvas-id="photo_canvas" style="width:{{canvasWidth}}px;height:{{canvasHeight}}px;position: absolute;left:-1000000px;top:-1000000px; "></canvas>

  <view class='greeting'>{{courseName}}签到</view>
  <view class='border'>
    <view>签到名称</view>
    <input class='input' placeholder='{{signinName}}' focus='{{focus}}' maxlength="15" bindinput='inputName'/>
  </view>

  <!-- <view class='greeting'>获取签到地点</view>
  <view class='border'>
    <view>签到地点记录</view>
    <form bindsubmit="openLocation">
      <view style='display: flex;flex-direction: row'>
        <button class='btn' disabled='{{isChecked<2}}' style='height:80rpx' bindtap='getLocation'>点击获取位置</button>
      </view> -->

        <view class='border'>
          <view>签到信息选择</view>
            <view class="img_hd" wx:if='{{isGotLoc}}' style="font-size:30rpx;">
              <view class="weui-uploader__title">经度
                <input class="weui-uploader__info" value="{{get_longitude}}°E" name="longitude" />
              </view>
              <view class="weui-uploader__title">纬度
                <input class="weui-uploader__info" value="{{get_latitude}}°N" name="latitude" />
              </view>
            </view>
            <view class="section__title">输入签到精度</view>
          <input class='input' placeholder='{{inputValue}}' maxlength="5" bindinput='bindKeyInput' />
            <view style="margin-bottom:10px"></view>
            <view class="section">
              <view class="section__title">选择签到开始时间</view>
              <picker
                mode="time"
                value="{{time}}"
                start="06:00"
                end="24:00"
                bindchange="bindTimeChange"
              >
                <view style="color:gray">
                  当前选择: {{time}}
                </view>
              </picker>
              <view class="section__title">输入签到持续时间</view>
              <input class='input' placeholder='{{lastMinutes}}' maxlength="5" bindinput='lastMinutes' />
            <view style="margin-bottom:10px"></view>
            </view>
      </view>
    </form>

  </view>

  <view class='greeting'>发布签到</view>
  <view class='border'>
    <button class="btn" style='width:400rpx;height:80rpx' bindtap='reg'>提交并发布签到</button>
  </view>
</template>
<script>
import wepy from 'wepy'

// 通过继承自wepy.page的类创建页面逻辑
export default class signinCreat extends wepy.page {
  config ={
    window: {
      backgroundTextStyle: 'light',
      navigationBarBackgroundColor: '#fff',
      navigationBarTitleText: '发布签到',
      navigationBarTextStyle: 'black'
    }
  }
  // 可用于页面模板绑定的数据
  data = {
    dated: '',
    signinName: '',
    courseName: '',
    idCourse: '',
    isGotLoc: 0,
    files: [],
    motto: 'hw',
    userInfo: {},
    // 默认未获取地址
    hasLocation: false,
    inputValue: '100',
    get_longitude: '',
    get_latitude: '',
    canvasWidth: '',
    canvasHeight: '',
    time: '23:01',
    horizontalAccuracy: 0,
    flag: [0, 0, 0],
    inputName: '',
    lastMinutes: 10
  }

  // 事件处理函数(集中保存在methods对象中)
  methods = {
    // 获取经纬度
    // getLocation: function(e) {
    //   wx.getSetting({
    //     success(e) {
    //       console.log(e.authSetting)
    //       if (e.authSetting['scope.userLocation'] === false) {
    //         wx.openSetting({
    //           success(e) {
    //             console.log(e)
    //           }
    //         })
    //       }
    //     }
    //   })
    //   var that = this
    //   wx.getLocation({
    //     type: 'wgs84',
    //     success: function(res) {
    //       console.log(res)
    //       that.isGotLoc = 1
    //       that.hasLocation = true
    //       that.new_longitude = res.longitude
    //       that.new_latitude = res.latitude
    //       that.get_longitude = res.longitude
    //       that.get_latitude = res.latitude
    //       that.horizontalAccuracy = res.horizontalAccuracy
    //       that.$apply()
    //       wx.showToast({
    //         title: '获取坐标成功'
    //       })
    //     }
    //   })
    // },
    // 提交位置信息
    reg: function(e) {
      // console.log(this.flag[0])
      var veg = /^\+?[1-9][0-9]*$/
      var isRight = veg.test(parseInt(this.inputValue))
      // console.log(isRight)
      let timestamp = Date.parse(new Date())
      let date = new Date(timestamp)
      // 获取月份
      let M = (date.getMonth() + 1 < 10 ? '0' + (date.getMonth() + 1) : date.getMonth() + 1)
      // 获取当日日期
      let D = date.getDate() < 10 ? '0' + date.getDate() : date.getDate()
      this.dated = new Date().getFullYear() + '-' + M + '-' + D + ' ' + this.time
      this.dated = new Date(this.dated.replace(/-/g, '/')).getTime()
      if (this.flag[0] === 0) {
        if (isRight === true) {
          let app = this.$parent
          var that = this
          let locationData = {
            signinName: this.signinName,
            gmtStart: parseInt(new Date().getTime() / 1000),
            gmtEnd: parseInt(this.dated / 1000) + parseInt(this.lastMinutes) * 60,
            latitude: this.get_latitude,
            longitude: this.get_longitude,
            radius: parseInt(this.inputValue),
            horizontalAccuracy: this.horizontalAccuracy,
            idCourse: this.idCourse,
            description: ''
          }
          let UL_DATA = {
            'locationData': locationData
          }
          app.request('Signin.createSignin', UL_DATA, 'loading')
          .then(function(e) {
            console.log(e)
            if (e.data.errCode === 0) {
              wx.showToast({
                title: '发布签到成功'
              })
              wx.navigateBack({
              })
            } else if (e.data.errCode === 4003) {
              that.flag[0] = 0
              wx.showModal({
                title: '发布失败',
                content: '请注意您是否设置正确的终止时间'
              })
            }
          },
          function(e) {
            that.flag[0] = 0
            wx.showModal({
              title: '发布失败',
              content: '请注意您发布信息是否完全'
            })
          })
        } else {
          wx.showModal({
            title: '注意',
            content: '请输入正确的签到范围'
          })
        }
      } else {
        wx.showToast({
          title: '已经在发布啦'
        })
      }
    },

    bindKeyInput: function(e) {
      this.inputValue = e.detail.value
    },
    inputName(e) {
      this.signinName = e.detail.value
    },
    lastMinutes(e) {
      this.lastMinutes = e.detail.value
    },
    bindTimeChange(e) {
      this.time = e.detail.value
    }
  }

  // 页面的生命周期函数
  onLoad(e) {
    wx.getSetting({
      success(e) {
        console.log(e.authSetting)
        if (e.authSetting['scope.userLocation'] === false) {
          wx.openSetting({
            success(e) {
              // console.log(e)
            }
          })
        }
      }
    })
    var that = this
    wx.getLocation({
      type: 'wgs84',
      success: function(res) {
        // console.log(res)
        that.isGotLoc = 1
        that.hasLocation = true
        that.new_longitude = res.longitude
        that.new_latitude = res.latitude
        that.get_longitude = res.longitude
        that.get_latitude = res.latitude
        that.horizontalAccuracy = res.horizontalAccuracy
        that.$apply()
        wx.showToast({
          title: '获取坐标成功'
        })
      }
    })
    // var veg = /^\+?[1-9][0-9]*$/
    // console.log(veg.test())
    this.courseName = e.courseName
    this.idCourse = e.idCourse
    let timestamp = Date.parse(new Date())
    let date = new Date(timestamp)
    // 获取月份
    let M = (date.getMonth() + 1 < 10 ? '0' + (date.getMonth() + 1) : date.getMonth() + 1)
    // 获取当日日期
    let D = date.getDate() < 10 ? '0' + date.getDate() : date.getDate()
    // console.log(M + '月' + D + '日')
    this.signinName = M + '月' + D + '日'
    var hourTime = date.getHours()
    var minuteTime = date.getMinutes()
    // console.log(hourTime + ':' + minuteTime)
    this.time = hourTime + ':' + minuteTime
    this.$apply()
  }
}
</script>
